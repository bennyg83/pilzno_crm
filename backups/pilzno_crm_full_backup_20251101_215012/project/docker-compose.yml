# Docker Compose configuration for Pilzno Synagogue Management System
# Development configuration with production override support
# Usage: docker-compose up -d (development) or docker-compose -f docker-compose.prod.yml up -d (production)
#
# ðŸš¨ CRITICAL BUILD PROCESS RULE:
# When deploying frontend changes, ALWAYS use this sequence:
# 1. docker --context desktop-linux compose down
# 2. cd frontend && npm run build && cd ..
# 3. docker --context desktop-linux compose up -d --build
#
# Building while containers run causes build context conflicts.
# See BUILD_PROCESS_TROUBLESHOOTING.md for detailed explanation.

services:
  # Database Service
  pilzno-synagogue-db:
    image: postgres:15-alpine
    container_name: pilzno-synagogue-db
    environment:
      POSTGRES_DB: ${DB_NAME:-pilzno_synagogue}
      POSTGRES_USER: ${DB_USER:-synagogue_admin}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-synagogue_secure_pass}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    ports:
      - "${DB_PORT:-5435}:5432"
    volumes:
      - pilzno-synagogue-db-data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    networks:
      - pilzno-synagogue-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-synagogue_admin} -d ${DB_NAME:-pilzno_synagogue}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # Backend Service
  pilzno-synagogue-backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.working
    container_name: pilzno-synagogue-backend
    environment:
      DATABASE_URL: postgresql://${DB_USER:-synagogue_admin}:${DB_PASSWORD:-synagogue_secure_pass}@pilzno-synagogue-db:5432/${DB_NAME:-pilzno_synagogue}
      JWT_SECRET: ${JWT_SECRET:-pilzno_synagogue_jwt_secret_key_2024}
      NODE_ENV: ${NODE_ENV:-development}
      DB_HOST: pilzno-synagogue-db
      DB_PORT: 5432
      DB_USER: ${DB_USER:-synagogue_admin}
      DB_PASSWORD: ${DB_PASSWORD:-synagogue_secure_pass}
      DB_NAME: ${DB_NAME:-pilzno_synagogue}
      PORT: 3001
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:3003}
    ports:
      - "${BACKEND_PORT:-3002}:3001"
    depends_on:
      pilzno-synagogue-db:
        condition: service_healthy
    volumes:
      - ./backend:/app
      - /app/node_modules
      - backend_logs:/app/logs
    networks:
      - pilzno-synagogue-network
    healthcheck:
      # Simple health check: ensures process is running
      test: ["CMD-SHELL", "ps aux | grep -v grep | grep ts-node"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  # Frontend Service
  # Note: Frontend waits for backend to be healthy
  # This ensures backend services are fully initialized before frontend starts
  pilzno-synagogue-frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.build
    container_name: pilzno-synagogue-frontend
    environment:
      VITE_API_BASE_URL: ${VITE_API_BASE_URL:-http://localhost:3002}
      NODE_ENV: ${NODE_ENV:-development}
    ports:
      - "${FRONTEND_PORT:-3003}:80"
    depends_on:
      pilzno-synagogue-backend:
        condition: service_healthy
    volumes:
      - ./frontend:/app
      - /app/node_modules
      - /app/dist
    networks:
      - pilzno-synagogue-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 2
      start_period: 45s
    restart: unless-stopped

volumes:
  pilzno-synagogue-db-data:
    driver: local
  backend_logs:
    driver: local

networks:
  pilzno-synagogue-network:
    driver: bridge
    ipam:
      config:
        - subnet: ${NETWORK_SUBNET:-172.25.0/16}